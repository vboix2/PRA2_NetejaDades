---
lang: ca-ES
title: "Pràctica 2: Neteja i validació de dades"
subtitle: "Tipologia i cicle de vida de les dades"
author: "Jesús Marí i Víctor Boix"
date: "Data de presentació: 11/06/2019"
output: 
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# Càrrega de paquets
library(colorspace)
library(grid)
library(data.table)
library(VIM)
library(ggplot2)
```

# 1. Descripció del dataset

El dataset utilitzat en aquesta pràctica s'ha obtingut de la pàgina web de *Kaggle*  (https://www.kaggle.com/c/titanic) i conté les dades dels passatgers del Titanic durant el desastre del 1912. L'objectiu d'aquest conjunt de dades és realitzar una predicció sobre la supervivència d'alguns passatgers a partir de les seves característiques. Per tant, es tracta d'un problema de classificació dins dels models d'aprenentatge supervisat, on cal construir un model capaç de determinar el valor de l'atribut *Survived* (variable objectiu o dependent) a partir de la resta d'atributs (variables independents). 

Les conjunt de dades està format per dos fitxers CSV:

* *Titanic_train.csv*. Conjunt d'entrenament que servirà per entrenar el model, per tant, conté l'atribut objectiu o classe *Survived*. Està format per 891 registres i 12 atributs.
* *Titanic_test.csv*. Conjunt de prova, conté els registres sobre els que cal realitzar la predicció. Està format per 418 registres i 11 atributs.

La informació que contenen els atributs és la següent:

* *PassengerId*. Identificador únic del viatger al dataset (nombre enter).
* *Survived*. Atribut que indica si el passatger va sobreviure a la catàstrofe (1: va sobreviure, 0: va morir). Només disponible al conjunt *train*.
* *Pclass*. Indica la classe en què viatjava el passatger (1: primera classe, 2: segona classe, 3: tercera classe).
* *Name*. Nom complet del viatger (cadena de text).
* *Sex*. Sexe del viatger (male: home, female: dona).
* *Age*. Edat del viatger en anys (nombre real).
* *SibSp*. Nombre de germans, germanes o marit/muller a bord del vaixell (nombre enter).
* *Parch*. Nombre de pares o fills a bord del vaixell (nombre enter).
* *Ticket*. Nombre del tiquet (cadena de text).
* *Fare*. Import pagat pel bitllet (nombre real).
* *Cabin*. Cabina on s'allotjava el passatger (cadena de text).
* *Embarked*. Port d'embarcament del viatger (C: Cherbourg, Q: Queenstown, S: Southampton).

# 2. Integració i selecció de les dades

Per tal de realitzar els processos de neteja i anàlisi de les dades carregarem els dos fitxers en
dos dataframes que anomenarem *train* i *test*. Totes les operacions de neteja les realitzarem sobre els dos dataframes.

```{r}
# Càrrega dels fitxers de dades
train <- read.csv('../data/Titanic_train.csv')
test <- read.csv('../data/Titanic_test.csv')
```

L'atribut *PassengerId* és un identificador numèric dels registres del dataframe que no ens aporta cap informació sobre els passatgers, per tant, l'eliminarem, ja que per identificar els registres ja disposem de l'índex.

```{r}
# Eliminem l'atribut PassengerId a train i test
train <- train[,-1]
test <- test[,-1]
```

La resta d'atributs els mantindrem perquè ens donen informació sobre el viatger i poden resultar útils per al model. Podem fer una visualització dels primers registres amb la funció *head()*.

```{r}
# Primers registres del dataframe train
head(train)
```

# 3. Neteja de les dades

Comencem examinant el dataframe amb la funció *str()*, que ens mostra el tipus de dada i els valors dels primers registres per a cada atribut.

```{r}
# Examinem el conjunt train
str(train)
```

```{r}
# Examinem el conjunt test
str(test)
```

Com veiem, els atributs *Survived* i *Pclass* són de tipus enter. El primer que farem es convertir-los a tipus factor.

```{r}
# Conversió de Survived i Pclass a factor
train[,'Survived'] <- factor(train[,'Survived'])
train[,'Pclass'] <- factor(train[,'Pclass'])
test[,'Pclass'] <- factor(test[,'Pclass'])
```

L'atribut *Name* és de tipus factor, però té tant nivells com registres; en aquest cas el convertirem a character.

```{r}
# Conversió de Name a character
train[,'Name'] <- as.character(train[,'Name'])
test[,'Name'] <- as.character(test[,'Name'])
```

Després d'aquestes transformacions, els tipus de dada per a cada atribut són:

* *Factor*: Survived, Pclass, Sex, Ticket, Cabin, Embarked
* *int*: SibSp, Parch
* *num*: Age, Fare
* *chr*: Name

Abans d'analitzar els elements buit i extrems pot resultar útil mostrar un resum de les dades amb la funció *summary()*.

```{r}
# Resum de les dades train
summary(train)
```

```{r}
# Resum de les dades test
summary(test)
```


## 3.1. Elements buits

Examinem els elements buits a les columnes dels dos conjunts de dades. Podem veure que tenim molts valors NA a la columna *Age* dels dos dataframes i un a la columna *Fare* del conjunt de test. 

```{r}
# Nombre de valors NA per atribut
sapply(train, function(x) sum(is.na(x)))
sapply(test, function(x) sum(is.na(x)))
```

A més, els atributs *Cabin* i *Embarked* també contenen valors buits.

```{r}
# Nombre de valors buits per atribut
sapply(train, function(x) nrow(train[x=='',]))
sapply(test, function(x) nrow(test[x=='',]))
```

**Fare**

Per imputar el valor buit del preu del bitllet (*Fare*) podem utilitzar la informació de la classe del viatger (*Pclass*), ja que és lògic pensar que els bitllets de millor classe seran més cars. Això ho podem confirmar mostrant la mitjana de *Fare* per a cada valor de *Pclass*.

```{r}
# Mitjana de Fare per cada valor de Pclass als conjunts train i test conjuntament
aggregate(Fare~Pclass, data=rbind(train[,-1],test), mean)
```

Com veiem, hi ha una diferència significativa entre la mitjana del preu de bitllet per a cada classe. Utilitzarem aquesta circumstància per imputar el valor NA de *Fare* amb la mitjana de valors per als viatgers de la mateixa classe.

```{r}
# Imputem el valor NA de Fare amb la mitjana de valors de la mateixa classe
test[is.na(test$Fare),'Fare'] <- aggregate(Fare~Pclass, data=rbind(train[,-1],test),
                                           mean)[test[is.na(test$Fare),'Pclass'],'Fare']
```

**Cabin**

Al cas de l'atribut *Cabin* substituirem els valors buits pel marcador 'UNKNOWN'.

```{r}
levels(train$Cabin)[levels(train$Cabin)==''] <- 'UNKNOWN'
levels(test$Cabin)[levels(test$Cabin)==''] <- 'UNKNOWN'
```

**Embarked**

Per imputar els valors buits del port d'embarcament (*Embarked*) podem aprofitar la informació del bitllet. Si consultem les dades dels viatgers que tenen un valor buit a *Embarked* veiem que tenen el mateix número de bitllet.

```{r}
# Ticket dels viatgers amb valor buit a Embarked
train[train$Embarked=='',c("Embarked", "Ticket")]
```

Si ampliem la cerca i mostrem el valor d'*Embarked* per a tots els viatgers amb un número de bitllet semblant (113XXX) veiem que la majoria han pujat a Southampton ('S'). Per tant assignarem aquest valor als dos valors buits d'*Embarked*.

```{r}
# Viatgers amb un número de ticket semblant a l'anterior (113XXX) agrupats pel valor d'Embarked
 summary(train[grep("113.*",train$Ticket),"Embarked"])

# Assignem el valor 'S' als valors buits d'Embarked
train[train$Embarked=='', "Embarked"] <- 'S'
```

**Age**

Finalment, per imputar el valor buit de l'edat (*Age*) farem servir el mètode basat en els k-veïns més propers (KNN). El que fa l'algorisme knn-imputation és identificar les k-observacions més properes i assignar la mitjana ponderada a l'atribut amb valor NA. En el nostre cas utilitzarem k=3 i tindrem en compte tots els atributs excepte *Name*.

```{r}
# Imputació de valors amb VIM
train$Age <- kNN(train[,-3], k=3)$Age 
test$Age <- kNN(test[,-2], k=3)$Age 
```


Per acabar, comprovem que ja no hi ha cap valor NA o buit.

```{r}
# Nombre de valors NA per atribut
sapply(train, function(x) sum(is.na(x)))
sapply(test, function(x) sum(is.na(x)))

# Nombre de valors buits per atribut
sapply(train, function(x) nrow(train[x=='',]))
sapply(test, function(x) nrow(test[x=='',]))
```

## 3.2. Valors extrems

Els valors extrems o *outliers* són aquells valors que es troben tan allunyats de la resta de valors que ens poden fer pensar que són erronis o tenen un origen diferent. Generalment es consideren *outliers* els valors que estan a més de 3 desviacions estàndards de la mitjana de la població. A continuació estudiarem els valors extrems per als atributs de tipus numèric, tant enters com reals.

**Age**

Si representem el diagrama de caixa de l'atribut *Age* veiem que la majoria de passatgers se situen entre els 20 i els 40 anys, però també apareixen alguns punts aïllats per sobre dels 60 anys.

```{r}
# Possibles outliers a l'atribut Age
boxplot(rbind(train[,-1],test)$Age, horizontal = TRUE)
```

Si mostrem els valors extrems per a aquest atribut obtenim molts valors entre 60 i 80.

```{r}
# Possibles outliers a l'atribut Age
boxplot.stats(rbind(train[,-1],test)$Age)$out
```

Com veiem, tot i que la funció detecta com a valors extrems les edats per sobre dels 60 anys, tots els passatgers se situen entre els 0 i els 80 anys, que són edats perfectament possibles i per tant mantindrem tots els registres sense cap modificació.

```{r}
# Rang total de l'atribut Age
range(rbind(train[,-1],test)$Age)
```

**SibSp**

```{r}
# Possibles outliers a l'atribut SibSp
boxplot.stats(rbind(train[,-1],test)$SibSp)$out
```

**Parch**

```{r}
# Possibles outliers a l'atribut Parch
boxplot.stats(rbind(train[,-1],test)$Parch)$out
```

**Fare**

```{r}
# Possibles outliers a l'atribut Fare
boxplot.stats(rbind(train[,-1],test)$Fare)$out
```


## 3.3. Conversió de dades

# 4. Anàlisi de dades

## 4.1. Selecció de dades

## 4.2. Normalitat i homogeneïtat de la variància

**Age**
Analitzarem la normalita de la distribució de l'atribut *Age*, primerament de manera gràfica i després amb el test de Kolmogorov-Smirnov y modificació de Lillefors.

```{r}

df <- rbind(train[,-1],test)

```
```{r}
ggplot(data = df, aes(x = Age)) +
  geom_histogram(aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient(low = "#DCDCDC", high = "#7C7C7C") +
  stat_function(fun = dnorm, colour = "firebrick",
                args = list(mean = mean(df$Age),
                            sd = sd(df$Age))) +
  ggtitle("Histograma + curva normal") +
  theme_bw()
```
```{r}
qqnorm(train$Age, pch = 19, col = "gray50")
qqline(train$Age)
```
```{r}
library(nortest)
alpha = 0.05 
col.names = colnames(train)
for (i in 1:ncol(train)) { 
  if (i == 1) cat("Variables que no siguen una distribución normal:\n") 
  if (is.integer(train[,i]) | is.numeric(train[,i])) { 
    p_val = ad.test(train[,i])$p.value 
    if (p_val < alpha) { 
      cat(col.names[i])
      # Format output 
      if (i < ncol(train) - 1) cat(", ") 
      if (i %% 3 == 0) cat("\n")
    }
  }
}
```

## 4.3. Proves estadístiques

# 5. Representació de dades

# 6. Resolució del problema

# 7. Codi

# 8. Recursos

