---
lang: ca-ES
title: "Pràctica 2: Neteja i validació de dades"
subtitle: "Tipologia i cicle de vida de les dades"
author: "Jesús Marí i Víctor Boix"
date: "Data de presentació: 11/06/2019"
output: 
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# Càrrega de paquets
library(colorspace)
library(grid)
library(data.table)
library(VIM)
library(ggplot2)
library(plyr)
```

# 1. Descripció del dataset

El dataset utilitzat en aquesta pràctica s'ha obtingut de la pàgina web de *Kaggle*  (https://www.kaggle.com/c/titanic) i conté les dades dels passatgers del Titanic durant el desastre del 1912. L'objectiu d'aquest conjunt de dades és realitzar una predicció sobre la supervivència d'alguns passatgers a partir de les seves característiques. Per tant, es tracta d'un problema de classificació d'aprenentatge supervisat, on cal construir un model capaç de determinar el valor de l'atribut *Survived* (variable objectiu o dependent) a partir de la resta d'atributs (variables independents). 

Les conjunt de dades està format per dos fitxers CSV:

* *Titanic_train.csv*. Conjunt d'entrenament que servirà per entrenar el model, per tant, conté l'atribut objectiu o classe *Survived*. Està format per 891 registres i 12 atributs.
* *Titanic_test.csv*. Conjunt de prova, conté els registres sobre els que cal realitzar la predicció. Està format per 418 registres i 11 atributs.

La informació que contenen els atributs és la següent:

* *PassengerId*. Identificador únic del viatger al dataset (nombre enter).
* *Survived*. Atribut que indica si el passatger va sobreviure a la catàstrofe (1: va sobreviure, 0: va morir). Només disponible al conjunt *train*.
* *Pclass*. Indica la classe en què viatjava el passatger (1: primera classe, 2: segona classe, 3: tercera classe).
* *Name*. Nom complet del viatger (cadena de text).
* *Sex*. Sexe del viatger (male: home, female: dona).
* *Age*. Edat del viatger en anys (nombre real).
* *SibSp*. Nombre de germans, germanes o marit/muller a bord del vaixell (nombre enter).
* *Parch*. Nombre de pares o fills a bord del vaixell (nombre enter).
* *Ticket*. Nombre del tiquet (cadena de text).
* *Fare*. Import pagat pel bitllet (nombre real).
* *Cabin*. Cabina on s'allotjava el passatger (cadena de text).
* *Embarked*. Port d'embarcament del viatger (C: Cherbourg, Q: Queenstown, S: Southampton).

# 2. Integració i selecció de les dades

Per tal de realitzar els processos de neteja i anàlisi de les dades carregarem els dos fitxers en
dos dataframes que anomenarem *train* i *test*. Totes les operacions de neteja les realitzarem sobre els dos dataframes.

```{r}
# Càrrega dels fitxers de dades
train <- read.csv('../data/Titanic_train.csv')
test <- read.csv('../data/Titanic_test.csv')
```

L'atribut *PassengerId* és un identificador numèric dels registres del dataframe que no ens aporta cap informació sobre els passatgers, per tant, l'eliminarem, ja que per identificar els registres ja disposem de l'índex.

```{r}
# Eliminem l'atribut PassengerId a train i test
train <- train[,-1]
test <- test[,-1]
```

La resta d'atributs els mantindrem perquè ens donen informació sobre el viatger i poden resultar útils per al model. Podem fer una visualització dels primers registres amb la funció *head()*.

```{r}
# Primers registres del dataframe train
head(train)
```

# 3. Neteja de les dades

Comencem examinant el dataframe amb la funció *str()*, que ens mostra el tipus de dada i els valors dels primers registres per a cada atribut.

```{r}
# Examinem el conjunt train
str(train)
```

```{r}
# Examinem el conjunt test
str(test)
```

L'atribut *Name* és de tipus factor, però té tant nivells com registres, per tant el convertirem a character.

```{r}
# Conversió de Name a character
train[,'Name'] <- as.character(train[,'Name'])
test[,'Name'] <- as.character(test[,'Name'])
```

Els tipus de dada per a cada atribut són:

* *Factor*: Sex, Ticket, Cabin, Embarked
* *int*: Survived, Pclass, SibSp, Parch
* *num*: Age, Fare
* *chr*: Name

Abans d'analitzar els elements buit i extrems pot resultar útil mostrar un resum de les dades amb la funció *summary()*.

```{r}
# Resum de les dades train
summary(rbind(train[-1],test))
```


## 3.1. Elements buits

Examinem els elements buits a les columnes dels dos conjunts de dades. Podem veure que tenim molts valors NA a la columna *Age* dels dos dataframes i un a la columna *Fare* del conjunt de test. 

```{r}
# Nombre de valors NA per atribut
sapply(train, function(x) sum(is.na(x)))
sapply(test, function(x) sum(is.na(x)))
```

A més, els atributs *Cabin* i *Embarked* també contenen valors buits.

```{r}
# Nombre de valors buits per atribut
sapply(train, function(x) nrow(train[x=='',]))
sapply(test, function(x) nrow(test[x=='',]))
```

**Fare**

Per imputar el valor buit del preu del bitllet (*Fare*) podem utilitzar la informació de la classe del viatger (*Pclass*), ja que és lògic pensar que els bitllets de millor classe seran més cars. Això ho podem confirmar mostrant la mitjana de *Fare* per a cada valor de *Pclass*.

```{r}
# Mitjana de Fare per cada valor de Pclass als conjunts train i test conjuntament
aggregate(Fare~Pclass, data=rbind(train[,-1],test), mean)
```

Com veiem, hi ha una diferència significativa entre la mitjana del preu de bitllet per a cada classe. Utilitzarem aquesta circumstància per imputar el valor NA de *Fare* amb la mitjana de valors per als viatgers de la mateixa classe.

```{r}
# Imputem el valor NA de Fare amb la mitjana de valors de la mateixa classe
test[is.na(test$Fare),'Fare'] <- aggregate(Fare~Pclass, data=rbind(train[,-1],test),
                                           mean)[test[is.na(test$Fare),'Pclass'],'Fare']
```

**Cabin**

En el cas de l'atribut *Cabin*, substituirem els valors buits pel marcador 'NO'.

```{r}
levels(train$Cabin)[levels(train$Cabin)==''] <- 'NO'
levels(test$Cabin)[levels(test$Cabin)==''] <- 'NO'
```

**Embarked**

Per imputar els valors buits del port d'embarcament (*Embarked*) podem aprofitar la informació del bitllet. Si consultem les dades dels viatgers que tenen un valor buit a *Embarked* veiem que tenen el mateix número de bitllet.

```{r}
# Ticket dels viatgers amb valor buit a Embarked
train[train$Embarked=='',c("Embarked", "Ticket")]
```

Si ampliem la cerca i mostrem el valor d'*Embarked* per a tots els viatgers amb un número de bitllet semblant (113XXX) veiem que la majoria han pujat a Southampton ('S'). Per tant assignarem aquest valor als dos valors buits d'*Embarked*.

```{r}
# Viatgers amb un número de ticket semblant a l'anterior (113XXX) agrupats pel valor d'Embarked
 summary(train[grep("113.*",train$Ticket),"Embarked"])

# Assignem el valor 'S' als valors buits d'Embarked
train[train$Embarked=='', "Embarked"] <- 'S'
```

**Age**

Finalment, per imputar el valor buit de l'edat (*Age*) farem servir el mètode basat en els k-veïns més propers (KNN). El que fa l'algorisme knn-imputation és identificar les k-observacions més properes i assignar la mitjana ponderada a l'atribut amb valor NA. En el nostre cas utilitzarem k=3 i tindrem en compte tots els atributs excepte *Name*.

```{r}
# Imputació de valors amb VIM
train$Age <- kNN(train[,-3], k=3)$Age 
test$Age <- kNN(test[,-2], k=3)$Age 
```


Per acabar, comprovem que ja no hi ha cap valor NA o buit.

```{r}
# Nombre de valors NA per atribut
sapply(train, function(x) sum(is.na(x)))
sapply(test, function(x) sum(is.na(x)))

# Nombre de valors buits per atribut
sapply(train, function(x) nrow(train[x=='',]))
sapply(test, function(x) nrow(test[x=='',]))
```

## 3.2. Valors extrems

Els valors extrems o *outliers* són aquells valors que es troben tan allunyats de la resta de valors que ens poden fer pensar que són erronis o tenen un origen diferent. Generalment es consideren *outliers* els valors que estan a més de 3 desviacions estàndards de la mitjana de la població. A continuació estudiarem els valors extrems per als atributs de tipus numèric, tant enters com reals.

**Age**

Si representem el diagrama de caixa de l'atribut *Age* veiem que la majoria de passatgers se situen entre els 20 i els 40 anys, però també apareixen alguns punts aïllats per sobre dels 60 anys.

```{r}
# Diagrama de caixa de l'atribut Age
A.Age <- c(train$Age,test$Age)
boxplot(A.Age, horizontal = TRUE)
```

Si mostrem els valors extrems per a aquest atribut obtenim molts valors entre 60 i 80.

```{r}
# Possibles outliers a l'atribut Age
boxplot.stats(A.Age)$out
```

Si calculem els valors que es troben per sobre de 3 desviacions estàndard el nombre d'*outliers* disminueix a només 3.

```{r}
# Edats superiors a 3 desviacions estàndard per sobre de la mitjana
A.Age[A.Age > (mean(A.Age) + 3 * sd(A.Age))]

# Rang total de l'atribut Age
range(A.Age)
```

Tot i que hem detectat 3 possibles outliers, tots els passatgers se situen entre els 0 i els 80 anys, que són edats perfectament possibles i per tant mantindrem tots els registres sense cap modificació.


**SibSp**

L'atribut *SibSp* ens indica el nombre de germans o marit/muller de cada passatger. Si mostrem la distribució de valors en una diagrama de caixa veiem que la majoria de valors se situen entre 0 i 1.

```{r}
# Diagrama de caixa de l'atribut SibSp
A.SibSp <- c(train$SibSp, test$SibSp)
boxplot(A.SibSp, horizontal = TRUE)
```

Repetint les anàlisis anteriors veiem que la funció *boxplot* detecta com a extrems els valors superiors a 2, si calculem els valors superiors a 3 desviacions estàndard trobem els valors superiors a 3, mentre que el valor més alt de l'atribut és de 8. Tots aquests valors són perfectament possibles com a nombre de fills i per tant també els mantidrem.

```{r}
# Possibles outliers a l'atribut SibSp
boxplot.stats(A.SibSp)$out

# Valors per sobre de 3 SD
A.SibSp[A.SibSp > (mean(A.SibSp) + 3 * sd(A.SibSp))]

# Rang total de l'atribut
range(A.SibSp)
```

**Parch**

L'atribut *Parch* indica el nombre de pares o fills al vaixell per a cada passatger. Si repetim els càlculs obtenim un resultat molt semblant a l'anterior. En aquest cas, la majoria de registres tenen un valor de 0, això fa que la mitjana sigui molt baixa i la resta de valors apareguin com a outliers. Malgrat tot, els rang de l'atribut se situa entre 0 i 9 fills, que són valors possibles i que encaixen amb els resultats de *SibSp*, per tant també els mantindrem.

```{r}
# Diagrama de caixa de l'atribut Parch
A.Parch <- c(train$Parch, test$Parch)
boxplot(A.Parch, horizontal = TRUE)
```

```{r}
# Possibles outliers a l'atribut Parch
boxplot.stats(A.Parch)$out

# Valors per sobre de 3 SD
A.Parch[A.Parch > (mean(A.Parch) + 3 * sd(A.Parch))]

# Rang total de l'atribut
range(A.Parch)
```

**Fare**

Per acabar estudiarem els valors extrem de l'atribut *Fare*, que indica el preu del bitllet de cada passatger. En aquest cas veiem que la majoria de bitllets se situen per sota de 50, tenim molts possibles *outliers* per sobre de 80 i un valor màxim superior als 500.

```{r}
# Diagrama de caixa de l'atribut Fare
A.Fare <- c(train$Fare, test$Fare)
boxplot(A.Fare, horizontal = TRUE)
```

```{r}
# Possibles outliers a l'atribut Fare
boxplot.stats(A.Fare)$out

# Valors per sobre de 3 SD
A.Fare[A.Fare > (mean(A.Fare) + 3 * sd(A.Fare))]

# Rang total de l'atribut
range(A.Fare)
```

Com en els casos anteriors, per a aquest atribut també hem decidit mantenir tots els valors.


## 3.3. Conversió de dades

A continuació transformarem alguns atributs per tal de reduir-ne el nombre de categories o obtenir-ne informació que pugui resultat interessant per a la fase d'anàlisi.

**Name**

A l'atribut *Name* n'extraurem el títol de tractament, ja que diferencia el seu estatus i pot influir en la supervivencia de l'individu.

```{r}
# Extraiem el títol de l'atribut Name
train$Titol <- sub(".*\\s([A-Za-z]+)\\..*", "\\1", train$Name)
test$Titol <- sub(".*\\s([A-Za-z]+)\\..*", "\\1", test$Name)

# Eliminem l'atribut Name perquè ja no ens serà útil
train <- train[,-3]
test <- test[,-2]
```

**Cabin**

L'atribut cabina conté més de 100 nivells. Una manera de reduir-los pot ser eliminar els números i conservar únicament la lletra, ja que segurament indica el tipus de cabina o la zona on s'allotjaven els passatgers i pot resultar significativa.

```{r}
# Extraiem la lletra de l'atribut Cabin
levels(train$Cabin)[-1] <- sub("([A-T]).*","\\1", levels(train$Cabin)[-1])
levels(test$Cabin)[-1] <- sub("([A-T]).*","\\1", levels(test$Cabin)[-1])
```

**Ticket**

Finalment, tot i que l'atribut *Ticket* també conté molts nivells i sembla poc útil, podem provar d'extreure'n alguna informació interessant. A continuació mostrem les dades d'alguns passatgers que comparteixen el valor de *Ticket*.

```{r}
# Valors més freqüents de Ticket
sort(table(train$Ticket), decreasing = TRUE)[c(1:5)]

# Passatgers amb el Ticket més freqüent
train[train$Ticket=='1601',]
```

Com veiem, els passatgers amb un mateix valor per a *Ticket* també comparteixen moltes característiques, perquè segurament formaven una família o viatjaven junts. Això ho aprofitarem per calcular la mida del grup de persones que viatjaven conjuntament i crear l'atribut *Group*.

```{r}
# Creem una taula de freqüències per als tickets
tickets <- as.data.frame(table(rbind(train["Ticket"],test["Ticket"])))
colnames(tickets) <- c("Ticket","Group")

# Assignem el valor de la freqüència a un nou atribut "Group"
train <- join(train, tickets, by="Ticket")
test <- join(test, tickets, by="Ticket")

# Eliminem l'atribut Ticket
train <- train[-7]
test <- test[-6]
```

**Fare**

Finalment, com que el preu del bitllet sembla ser el mateix per a cada ticket, és a dir, sembla tractar-se de l'import per a tot el grup, dividirem l'import del passatge (*Fare*) per les dimensions del grup (*Group*) per tal d'obtenir el preu individual del bitllet.

```{r}
# Càlcul del preu individual del bitllet
train$Fare <- train$Fare / train$Group 
test$Fare <- test$Fare / test$Group
```


## 3.4. Exportació de dades

Una vegada hem netejat les dades les exportarem en un nou fitxer.

```{r}
# Exportació dels conjunt train i test nets
write.csv(train, '../data/Titanic_train_clean.csv')
write.csv(test, '../data/Titanic_test_clean.csv')
```

# 4. Anàlisi de dades

## 4.1. Selecció de dades

## 4.2. Normalitat i homogeneïtat de la variància

**Age**

Analitzarem la normalitat de la distribució de l'atribut *Age*, primer de manera gràfica i després amb el test d'Anderson-Darlings.

```{r}
# Unim les dades en un dataframe
test_and_train <- rbind(train[,-1],test)

# Representem les dades en un histograma
ggplot(data = test_and_train, aes(x = Age)) +
  geom_histogram(aes(y = ..density.., fill = ..count..)) +
  scale_fill_gradient(low = "#DCDCDC", high = "#7C7C7C") +
  stat_function(fun = dnorm, colour = "firebrick",
                args = list(mean = mean(test_and_train$Age),
                            sd = sd(test_and_train$Age))) +
  ggtitle("Histograma + curva normal") +
  theme_bw()
```


```{r}
qqnorm(test_and_train$Age, pch = 19, col = "gray50")
qqline(test_and_train$Age)
```


```{r}
library(nortest)
alpha = 0.05 
col.names = colnames(test_and_train)
for (i in 1:ncol(test_and_train)) { 
  if (i == 1) cat("Variables que no siguen una distribución normal:\n") 
  if (is.integer(test_and_train[,i]) | is.numeric(test_and_train[,i])) { 
    p_val = ad.test(test_and_train[,i])$p.value 
    if (p_val < alpha) { 
      cat(col.names[i])
      # Format output 
      if (i < ncol(test_and_train) - 1) cat(", ") 
      if (i %% 3 == 0) cat("\n")
    }
  }
}
```

## 4.3. Proves estadístiques

En aquest apartat analitzarem les dades des de tres punts de vista, intentant respondre tres preguntes diferents sobre les dades:

* Quines variables numèriques influeixen més en la supervivència dels passatgers?
* El sexe del passatger influeix en la seva probabilitat de sobreviure?
* Quins passatgers del conjunt *test* tenen més probabilitats de sobreviure?


### 4.3.1. Anàlisi de correlació

A la primera anàlisi ens preguntem quines variables numèriques influeixen més en la supervivència dels passatger. Per respondre-la utilitzarem un anàlisi de correlació entre les diferents variables quantitatives per al conjunt *train*, que és l'únic que conté l'atribut *Survived*. Per mesurar el grau de correlació utilitzarem el coeficient de *Pearson*.

```{r}
# Correlació entre variables numèriques
cor(train[c("Survived","Pclass","Age","SibSp","Parch","Fare","Group")], method="pearson")
```

### 4.3.2. Contrast d'hipòtesis

A la segona anàlisi ens preguntem si el sexe del passatger influeix en la seva probabilitat de sobreviure.

### 4.3.3. Regressió logística

Finalment, intentarem realitzar una predicció sobre la supervivència dels passatgers del conjunt *test*.


# 5. Representació de dades

# 6. Resolució del problema

# 7. Codi

# 8. Recursos

